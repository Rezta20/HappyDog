<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Google Font  -->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome  -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    />

    <!-- React  -->
    <script src="https://unpkg.com/react@16.13.1/umd/react.development.js"></script>
    <!-- React DOM -->
    <script src="https://unpkg.com/react-dom@16.13.1/umd/react-dom.development.js"></script>
    <!-- JSX Babel -->
    <script src="https://unpkg.com/@babel/standalone@7.8.3/babel.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="../../css/navbar.css" />
    <link rel="stylesheet" href="../../css/photowall.css" />

    <!-- Favicon  -->
    <link rel="icon" type="image/png" href="../img/favicon.png" />

    <title>Happy Dog</title>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar-ForMobie">
      <!-- Logo -->
      <div class="navbar-logoLoginWrapper">
        <div class="navbar-logoWrapper">
          <a class="logo-A" href="/Html/homepage.html">
            <img class="logo" src="../img/logo.png" alt="happyDog-logo" />
          </a>
        </div>

        <!-- Navbar Log In  -->
        <div class="login-wrapper notLoginState">
          <a class="login-A" href="/Html/Login/login.html">
            <button class="navbar-text loginBtn">登入</button>
          </a>
        </div>

        <div class="login-wrapper loginState">
          <p class="navbar-text">
            汪，登入中&emsp;<span
              ><a class="login-A toMemberpage" href="/Html/Login/member.html">
                <i class="far fa-user-circle"></i> </a
            ></span>
          </p>
        </div>
      </div>

      <!-- Navbar Elements -->
      <div class="navbariconWrapperFlex">
        <div class="navbar-iconWrapper">
          <div class="navbar-element">
            <a class="navbar-A" href="/Html/homepage.html">
              <div class="navbarIcon homeIcon"></div>
              <div class="navbar-text">寵物當家</div>
            </a>
          </div>
          <div class="navbar-element">
            <a class="navbar-A" href="/Html/Booking/bookingWalking.html">
              <div class="navbarIcon bookingWalkingIcon"></div>
              <div class="navbar-text">預約散步</div>
            </a>
          </div>
          <div class="navbar-element">
            <a class="navbar-A" href="/Html/photowall.Html">
              <div class="navbarIcon photoIcon"></div>
              <div class="navbar-text">毛孩日誌</div>
            </a>
          </div>
          <div class="navbar-element">
            <a class="navbar-A" href="/Html/Contact/Contact.html">
              <div class="navbarIcon contactIcon"></div>
              <div class="navbar-text">聯絡我們</div>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <!-- Loading -->
    <div class="loadingWrapper">
      <div class="loading">
        <img class="loadingGif" src="/img/loading.gif" alt="" />
      </div>
    </div>

    <!-- Content -->
    <div class="rootWrapper">
      <div id="root"></div>
    </div>

    <!-- Footer -->
    <footer>
      <div class="footer-background"></div>
    </footer>

    <!-- FrieBase  -->
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-analytics.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.1.2/firebase-storage.js"></script>

    <script>
      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      var firebaseConfig = {
        apiKey: "AIzaSyBL9Tmhwb15yAohPn_DLoAFUgVJoy76bnk",
        authDomain: "happydog-82c2f.firebaseapp.com",
        databaseURL: "https://happydog-82c2f.firebaseio.com",
        projectId: "happydog-82c2f",
        storageBucket: "happydog-82c2f.appspot.com",
        messagingSenderId: "1070136598571",
        appId: "1:1070136598571:web:0de4a08e0493465e984a6e",
        measurementId: "G-N3V1TLZNZW",
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();
    </script>
    <script src="../../JavaScript/ifLogin.js"></script>

    <!-- React Select  -->
    <script src="https://cdn.jsdelivr.net/npm/emotion@9.2.12/dist/emotion.umd.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.5.10/prop-types.min.js"></script>
    <script src="https://unpkg.com/react-input-autosize@2.2.1/dist/react-input-autosize.min.js"></script>
    <script src="https://unpkg.com/react-select@2.1.2/dist/react-select.min.js"></script>

    <!-- <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script> -->
    <script>
      // Firebase 監聽
      window.addEventListener("load", function () {
        firebase.auth().onAuthStateChanged((user) => {
          if (user) {
            console.log("sign in");
            console.log(user);
            console.log(user.email);
            loginState.style.display = "flex";
            notLoginState.style.display = "none";
          } else {
            console.log("user is sign out");
            console.log(user);
            loginState.style.display = "none";
            notLoginState.style.display = "flex";
          }
        });
      });
    </script>

    <script type="text/babel">
      function Card(props) {
        return (
          <div className="cardWrapper">
            <div className="cardUserTitle">
              <div
                className="userImg"
                style={{ backgroundImage: `url(${props.userImg})` }}
              ></div>
              <div className="userName">{props.userName}</div>
            </div>
            <img className="photoImg" src={props.photoImgUrl} />
            <div className="titleHeartWrapper">
              <div className="tags">
                {props.hashTags?.map((data) => (
                  <span>#{data} </span>
                ))}
              </div>
            </div>
          </div>
        );
      }

      function Tags(props) {
        const [options, setOptions] = React.useState([]);

        React.useEffect(() => {
          // const options = [
          //   {
          //     value: "可愛",
          //     label: "可愛",
          //   },
          //   {
          //     value: "開心",
          //     label: "開心",
          //   },
          //   {
          //     value: "有趣",
          //     label: "有趣",
          //   },
          //   {
          //     value: "米克斯",
          //     label: "米克斯",
          //   },
          //   {
          //     value: "柴犬",
          //     label: "柴犬",
          //   },
          //   {
          //     value: "冒險家",
          //     label: "冒險家",
          //   },
          // ];
          // setOptions(options);

          // Firebase firestore initializ
          const db = firebase.firestore();
          const firestoreCollection = db.collection("photoTags");

          firestoreCollection.get().then(function (docs) {
            const options = [];
            docs.forEach((doc) => {
              console.log(doc.data());
              options.push({ value: doc.data().tag, label: doc.data().tag });
            });
            //   // React select
            //   const options = [
            //     {
            //       value: "獒犬",
            //       label: "獒犬",
            //     },
            //     {
            //       value: "米克斯",
            //       label: "米克斯",
            //     }
            //   ];
            setOptions(options);
          });
        }, []);
        //

        function handleChange(newValue) {
          console.log(newValue);

          if (newValue.length - 1 === -1) {
          } else {
            firebase
              .firestore()
              .collection("photoTags")
              .where("tag", "==", `${newValue[newValue.length - 1].label}`)
              .get()
              .then(function (querySnapshot) {
                if (querySnapshot.empty) {
                  firebase
                    .firestore()
                    .collection("photoTags")
                    .add({
                      tag: newValue[newValue.length - 1].label,
                    })
                    .then(function (docRef) {
                      console.log("upload success");
                    })
                    .catch(function (error) {
                      console.error("Error writing document: ", error);
                    });
                }
              })
              .catch(function (error) {
                console.log("Error getting documents: ", error);
              });
          }
        }

        return (
          <Select.Creatable
            defaultValue={[options[0], options[1]]}
            options={options}
            isMulti
            name="tags"
            className="basic-multi-select"
            classNamePrefix="select"
            onChange={handleChange}
          />
        );
      }

      function UploadCard(props) {
        const [previewFile, setPreviewFile] = React.useState();

        function previewPicture() {
          document.querySelector(".previewText").style.display = "none";
          document
            .querySelector(".previewPicture")
            .setAttribute(
              "style",
              "width:320px; height: 401px; object-fit:contain"
            );
          const picture = URL.createObjectURL(event.target.files[0]);
          setPreviewFile(picture);
        }

        function sendData() {
          // Get a reference to the storage service, which is used to create references in your storage bucket
          const ref = firebase.storage().ref();
          const db = firebase.firestore();
          const picture = document.querySelector("#upload").files[0];

          //  unique id
          let randomNumber = Math.floor(Math.random() * 1000);
          let time = Date.now();
          let pictureName = `photoWallPicture ${randomNumber}${time}`;

          ref
            .child(pictureName)
            .put(picture)
            .then(function (snapshot) {
              console.log("Uploaded a blob or file!");

              ref
                .child(pictureName)
                .getDownloadURL()
                .then(function (url) {
                  // `url` is the download URL for 'images/stars.jpg'
                  const user = firebase.auth().currentUser;
                  const userData = user.providerData[0];
                  console.log(userData);
                  db.collection("photowall")
                    .add({
                      photo: url,
                      content: "",
                      rank: Date.now(),
                      time: `${new Date().getFullYear()}/${
                        new Date().getMonth() + 1
                      }/${new Date().getDate()}`,
                      user: userData.displayName,
                      userPhoto: userData.photoURL,
                      uid: userData.uid,
                    })
                    .then(function (docRef) {
                      // clicked = false;
                      console.log("Document successfully written!");
                    })
                    .catch(function (error) {
                      console.error("Error writing document: ", error);
                    });
                });
            })
            .catch(function (error) {
              console.log("Image Error");
            });
        }

        return (
          <div className="uploadCardWrapperFlex">
            <div
              className="cover"
              onClick={() => {
                props.setShowUpload(false);
              }}
            ></div>
            <div className="uploadCardWrapper">
              <div className="crossWrapper">
                <i
                  className="fas fa-times"
                  onClick={() => {
                    props.setShowUpload(false);
                  }}
                ></i>
              </div>
              <div className="uploadContentWrapper">
                <div className="uploadArea">
                  <p className="previewText">預覽圖片</p>
                  <img className="previewPicture" src={previewFile} alt="" />
                </div>
                <div className="uploadIconWrapper">
                  <label htmlFor="upload" className="uploadIcon">
                    <div className="uploadText">上傳圖片</div>
                    <i className="fas fa-file-upload fa-2x"></i>
                  </label>
                  <input
                    type="file"
                    id="upload"
                    name="image"
                    accept="image/jpg, image/png, image/svg"
                    onChange={previewPicture}
                  />
                </div>
                <Tags />
              </div>

              <div className="sendPhotoBtnWrapper">
                <button className="sendPhotoBtn" onClick={sendData}>
                  確認送出
                </button>
              </div>
            </div>
          </div>
        );
      }

      function CardGroup(props) {
        const [show, setShow] = React.useState(false);
        const [index, setIndex] = React.useState(0);
        const [data, setData] = React.useState([]);
        const [showUpload, setShowUpload] = React.useState(false);

        React.useEffect(() => {
          // Firebase firestore initializ
          const db = firebase.firestore();
          const firestoreCollection = db.collection("photowall");

          firestoreCollection.get().then(function (doc) {
            const dataArray = [];
            doc.forEach(function (doc) {
              dataArray.push(doc.data());
            });
            setData(dataArray);
          });
        }, []);

        const cards = [];

        for (let i = 0; i < data.length; i++) {
          cards.push(
            <Card
              key={i}
              userImg={data[i].userPhoto}
              userName={data[i].user}
              photoImgUrl={data[i].photo}
              hashTags={data[i].hashtags}
              setShow={setShow}
              setIndex={setIndex}
              index={i}
            />
          );
        }

        return (
          <>
            <div className="uploadBtnWrapper">
              <div className="uploadPictureDescriptionWrapper">
                <div className="uploadPictureDescription">
                  趕快上傳照片，和我們分享你家寶貝最可愛的一面吧！
                </div>
                <div className="uploadPictureDescriptionTriangle"></div>
              </div>
              <button
                className="uploadBtn"
                onClick={() => {
                  setShowUpload(true);
                }}
              >
                上傳照片
              </button>
            </div>
            <div className="tagsWrapper">
              <button className="titleTags">全部</button>
              <button className="titleTags">可愛</button>
              <button className="titleTags">有趣</button>
              <button className="titleTags">黃色系</button>
              <button className="titleTags">黑色系</button>
              <button className="titleTags">米克斯</button>
            </div>
            {showUpload && <UploadCard setShowUpload={setShowUpload} />}
            <div className="cardsWrapper">{cards}</div>
          </>
        );
      }

      ReactDOM.render(<CardGroup />, document.getElementById("root"));
    </script>
  </body>
</html>
