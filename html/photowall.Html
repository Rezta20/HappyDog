<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Google Font  -->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome  -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    />

    <!-- Sweetalert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    <!-- React  -->
    <script src="https://unpkg.com/react@16.13.1/umd/react.development.js"></script>
    <!-- React DOM -->
    <script src="https://unpkg.com/react-dom@16.13.1/umd/react-dom.development.js"></script>
    <!-- JSX Babel -->
    <script src="https://unpkg.com/@babel/standalone@7.8.3/babel.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="../../css/navbar.css" />
    <link rel="stylesheet" href="../../css/loading.css" />
    <link rel="stylesheet" href="../../css/photowall.css" />

    <!-- Favicon  -->
    <link rel="icon" type="image/png" href="../img/favicon.png" />

    <title>Happy Dog</title>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar-ForMobile">
      <!-- Logo -->
      <div class="navbar-logoLoginWrapper">
        <div class="navbar-logoWrapper">
          <a class="logo-A" href="/Html/homepage.html">
            <img class="logo" src="../img/logo.png" alt="happyDog-logo" />
          </a>
        </div>

        <!-- Navbar Log In  -->
        <div class="login-wrapper notLoginState">
          <a class="login-A" href="/Html/Login/login.html">
            <button class="navbar-text loginBtn">登入</button>
          </a>
        </div>

        <div class="login-wrapper loginState">
          <p class="navbar-text">
            <span class="userLoginName">汪</span>，登入中&emsp;
            <span
              ><a class="login-A toMemberpage" href="/Html/Login/member.html">
                <i class="far fa-user-circle"></i
              ></a>
            </span>
          </p>
          <a class="login-A toMemberpage" href="/Html/Login/member.html"
            ><div class="userPhoto"></div
          ></a>
        </div>
      </div>

      <!-- Navbar Elements -->
      <div class="navbariconWrapperFlex">
        <div class="navbar-iconWrapper">
          <div class="navbar-element">
            <a class="navbar-A" href="/Html/homepage.html">
              <div class="navbarIcon homeIcon"></div>
              <div class="navbar-text">寵物當家</div>
            </a>
          </div>
          <div class="navbar-element">
            <a class="navbar-A" href="/Html/Booking/bookingWalking.html">
              <div class="navbarIcon bookingWalkingIcon"></div>
              <div class="navbar-text">預約散步</div>
            </a>
          </div>
          <div class="navbar-element">
            <a class="navbar-A" href="/Html/photowall.html">
              <div class="navbarIcon photoIcon"></div>
              <div class="navbar-text">毛孩日誌</div>
            </a>
          </div>
          <div class="navbar-element">
            <a class="navbar-A" href="/Html/Contact/contact.html">
              <div class="navbarIcon contactIcon"></div>
              <div class="navbar-text">聯絡我們</div>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <!-- Loading -->
    <div class="loadingWrapper">
      <div class="loading">
        <img class="loadingGif" src="/img/loading.gif" alt="" />
      </div>
    </div>

    <!-- Content -->
    <div class="contentWrapper">
      <div class="rootWrapper">
        <div id="root"></div>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <div class="footer-background">Copyright © 2020 Happy Dog</div>
    </footer>

    <!-- FrieBase  -->
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-analytics.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.1.2/firebase-storage.js"></script>

    <script>
      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      var firebaseConfig = {
        apiKey: "AIzaSyBL9Tmhwb15yAohPn_DLoAFUgVJoy76bnk",
        authDomain: "happydog-82c2f.firebaseapp.com",
        databaseURL: "https://happydog-82c2f.firebaseio.com",
        projectId: "happydog-82c2f",
        storageBucket: "happydog-82c2f.appspot.com",
        messagingSenderId: "1070136598571",
        appId: "1:1070136598571:web:0de4a08e0493465e984a6e",
        measurementId: "G-N3V1TLZNZW",
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();
    </script>

    <script src="../../JavaScript/ifLogin.js"></script>
    <script src="../../JavaScript/loading.js"></script>

    <!-- React Select  -->
    <script src="https://cdn.jsdelivr.net/npm/emotion@9.2.12/dist/emotion.umd.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.5.10/prop-types.min.js"></script>
    <script src="https://unpkg.com/react-input-autosize@2.2.1/dist/react-input-autosize.min.js"></script>
    <script src="https://unpkg.com/react-select@2.1.2/dist/react-select.min.js"></script>

    <script>
      // Firebase 監聽
      window.addEventListener("load", function () {
        firebase.auth().onAuthStateChanged((user) => {
          if (user) {
            loginState.style.display = "flex";
            notLoginState.style.display = "none";
          } else {
            loginState.style.display = "none";
            notLoginState.style.display = "flex";
          }
        });
      });
    </script>

    <script type="text/babel">
      function Card(props) {
        return (
          <div className="cardWrapper">
            <div className="cardUserTitle">
              <img className="userImg" src={props.userImg} />
              <div className="userName">{props.userName}</div>
            </div>
            <img className="photoImg" src={props.photoImgUrl} />

            <div className="tags">
              {props.hashTags?.map((data) => (
                <span> #{data.value} </span>
              ))}
            </div>
            <div className="cardDate">{props.cardDate}</div>
          </div>
        );
      }

      function Tags(props) {
        const [options, setOptions] = React.useState([]);

        React.useEffect(() => {
          // Firebase firestore initializ
          const db = firebase.firestore();
          const firestoreCollection = db.collection("photoTags");

          firestoreCollection.get().then(function (docs) {
            const options = [];
            docs.forEach((doc) => {
              options.push({ value: doc.data().tag, label: doc.data().tag });
            });
            // TODO: 按照字數排序
            options.sort(function (a, b) {
              return a.value.length - b.value.length;
            });

            setOptions(options);
          });
        }, []);
        //

        function handleChange(newValue) {
          props.setSaveTag(newValue);

          if (newValue.length - 1 === -1) {
          } else {
            firebase
              .firestore()
              .collection("photoTags")
              .where("tag", "==", `${newValue[newValue.length - 1].label}`)
              .get()
              .then(function (querySnapshot) {
                if (querySnapshot.empty) {
                  firebase
                    .firestore()
                    .collection("photoTags")
                    .add({
                      tag: newValue[newValue.length - 1].label,
                    })
                    .then(function (docRef) {
                      console.log("upload success");
                    })
                    .catch(function (error) {
                      console.error("Error writing document: ", error);
                    });
                }
              })
              .catch(function (error) {
                console.log("Error getting documents: ", error);
              });
          }
        }

        return (
          <Select.Creatable
            defaultValue={[options[0], options[1]]}
            options={options}
            isMulti
            name="tags"
            className="select-container"
            classNamePrefix="select"
            onChange={handleChange}
            menuPlacement="top"
            placeholder="請選喜歡的標籤"
          />
        );
      }

      function UploadCard(props) {
        const [previewFile, setPreviewFile] = React.useState("");
        const [saveTag, setSaveTag] = React.useState([]);
        const [alreadyUpload, setAlreadyUpload] = React.useState(true);

        function previewPicture() {
          document.querySelector(".previewText").style.display = "none";
          document
            .querySelector(".previewPicture")
            .setAttribute(
              "style",
              "width:320px; height: 401px; object-fit:contain"
            );
          const picture = URL.createObjectURL(event.target.files[0]);
          setPreviewFile(picture);
        }

        function sendData() {
          // Get a reference to the storage service, which is used to create references in your storage bucket
          const ref = firebase.storage().ref();
          const db = firebase.firestore();
          const picture = document.querySelector("#upload").files[0];
          let deleteIsNewTag;
          console.log(saveTag);
          //  unique id
          let randomNumber = Math.floor(Math.random() * 1000);
          let time = Date.now();
          let pictureName = `photoWallPicture ${randomNumber}${time}`;
          const nativeImg =
            "https://firebasestorage.googleapis.com/v0/b/happydog-82c2f.appspot.com/o/logo%2FlogoNative1.png?alt=media&token=682b9c60-f667-471c-9169-fd69f36a9f21";

          // Cut is New element
          saveTag.forEach((item) => {
            console.log(item);
            console.log(item.__isNew__);
            console.log(item.label);
            deleteIsNewTag = delete item.__isNew__;
            console.log(deleteIsNewTag);
            console.log(saveTag);
            console.log("hello");
          });

          if (previewFile === "") {
            Swal.fire({
              title: "請上傳圖片唷",
              icon: "warning",
              confirmButtonText: "確定",
            });
          } else {
            if (alreadyUpload) {
              setAlreadyUpload(false);
              ref
                .child(pictureName)
                .put(picture)
                .then(function (snapshot) {
                  console.log("Uploaded a blob or file!");

                  ref
                    .child(pictureName)
                    .getDownloadURL()
                    .then(function (url) {
                      // `url` is the download URL for 'images/stars.jpg'
                      const user = firebase.auth().currentUser;
                      const userData = user.providerData[0];

                      if (
                        userData.displayName === null ||
                        userData.photoURL === null
                      ) {
                        db.collection("photoWall")
                          .add({
                            photo: url,
                            hashTags: saveTag,
                            rank: firebase.firestore.FieldValue.serverTimestamp(),
                            time: `${new Date().getFullYear()}.${
                              new Date().getMonth() + 1
                            }.${new Date().getDate()}`,
                            user: "Happy Dog",
                            userPhoto: nativeImg,
                            uid: userData.uid,
                          })
                          .then(function (docRef) {
                            console.log("Document successfully written!");
                            props.setShowUpload(false);
                            setAlreadyUpload(true);
                          })
                          .catch(function (error) {
                            console.error("Error writing document: ", error);
                          });
                      } else {
                        db.collection("photoWall")
                          .add({
                            photo: url,
                            hashTags: saveTag,
                            rank: firebase.firestore.FieldValue.serverTimestamp(),
                            time: `${new Date().getFullYear()}.${
                              new Date().getMonth() + 1
                            }.${new Date().getDate()}`,
                            user: userData.displayName,
                            userPhoto: userData.photoURL,
                            uid: userData.uid,
                          })
                          .then(function (docRef) {
                            // clicked = false;
                            console.log("Document successfully written!");
                            props.setShowUpload(false);
                            setAlreadyUpload(true);
                          })
                          .catch(function (error) {
                            console.error("Error writing document: ", error);
                          });
                      }
                    });
                })
                .catch(function (error) {
                  console.log("Image Error");
                });
            }
          }
        }

        return (
          <div className="uploadCardWrapperFlex">
            <div
              className="cover"
              onClick={() => {
                props.setShowUpload(false);
              }}
            ></div>
            <div className="uploadCardWrapper fade-in-fwd">
              <div className="crossWrapper">
                <i
                  className="fas fa-times"
                  onClick={() => {
                    props.setShowUpload(false);
                  }}
                ></i>
              </div>
              <div className="uploadContentWrapper">
                <div className="uploadArea">
                  <p className="previewText">預覽圖片</p>
                  <img className="previewPicture" src={previewFile} alt="" />
                </div>
                <div className="uploadIconWrapper">
                  <label htmlFor="upload" className="uploadIcon">
                    <div className="uploadText">上傳圖片</div>
                    <i className="fas fa-file-upload fa-2x"></i>
                  </label>
                  <input
                    type="file"
                    id="upload"
                    name="image"
                    accept="image/jpg, image/png, image/svg"
                    onChange={previewPicture}
                  />
                </div>
                <Tags setSaveTag={setSaveTag} />
              </div>

              <div className="sendPhotoBtnWrapper">
                <button className="sendPhotoBtn" onClick={sendData}>
                  {alreadyUpload ? "確認送出" : "送出中"}
                </button>
              </div>
            </div>
          </div>
        );
      }

      function CardGroup(props) {
        const [show, setShow] = React.useState(false);
        const [index, setIndex] = React.useState(0);
        const [data, setData] = React.useState([]);
        const [showUpload, setShowUpload] = React.useState(false);
        const [tagView, setTagView] = React.useState("全部");

        // 從Firebase上 抓資料
        React.useEffect(() => {
          // Firebase firestore initializ
          const db = firebase.firestore();
          const firestoreCollection = db.collection("photoWall");

          firestoreCollection
            .orderBy("rank", "desc")
            .onSnapshot(function (doc) {
              const dataArray = [];
              doc.forEach(function (doc) {
                dataArray.push(doc.data());
              });
              setData(dataArray);
            });
        }, []);

        const cards = [];

        for (let i = 0; i < data.length; i++) {
          let shouldPushCard = false;
          /* TODO: 如果 data 裡的 hashTags 有包含 tagView 就 push 進去 */
          if (tagView === "全部") {
            shouldPushCard = true;
          } else {
            data[i].hashTags.forEach((item) => {
              if (item.label === tagView) {
                shouldPushCard = true;
              }
            });
          }
          if (shouldPushCard) {
            // true
            console.log(data);
            console.log("data");
            cards.push(
              <Card
                key={data[i].rank}
                index={i}
                userImg={data[i].userPhoto}
                userName={data[i].user}
                photoImgUrl={data[i].photo}
                hashTags={data[i].hashTags}
                cardDate={data[i].time}
                setShow={setShow}
                setIndex={setIndex}
              />
            );
          }
        }

        function toTop() {
          window.scrollTo({ top: 0, behavior: "smooth" });
        }

        return (
          <>
            <div className="uploadBtnWrapper">
              <div className="uploadPictureDescriptionWrapper">
                <div className="uploadPictureDescription">
                  趕快上傳照片，和我們分享你家寶貝最可愛的一面吧！
                </div>
                <div className="uploadPictureDescriptionTriangle"></div>
              </div>

              <button
                className="uploadBtn"
                onClick={() => {
                  if (firebase.auth().currentUser === null) {
                    Swal.fire({
                      title: "請先登入帳號",
                      icon: "warning",
                      confirmButtonText: "確定",
                    }).then(function () {
                      location.href = "../Html/Login/login.html";
                    });
                  } else {
                    setShowUpload(true);
                  }
                }}
              >
                上傳圖片
              </button>
            </div>

            <div className="titleTagsOutsideWrapper">
              <div className="titleTagsWrapper">
                <button
                  className={`titleTags ${
                    tagView === "全部" ? "selected" : ""
                  }`}
                  onClick={() => {
                    setTagView("全部");
                  }}
                >
                  全部
                </button>
                <button
                  className={`titleTags ${
                    tagView === "可愛" ? "selected" : ""
                  }`}
                  onClick={() => {
                    setTagView("可愛");
                  }}
                >
                  可愛
                </button>
                <button
                  className={`titleTags ${
                    tagView === "有趣" ? "selected" : ""
                  }`}
                  onClick={() => {
                    setTagView("有趣");
                  }}
                >
                  有趣
                </button>
                <button
                  className={`titleTags ${
                    tagView === "黃色系" ? "selected" : ""
                  }`}
                  onClick={() => {
                    setTagView("黃色系");
                  }}
                >
                  黃色系
                </button>
                <button
                  className={`titleTags ${
                    tagView === "黑色系" ? "selected" : ""
                  }`}
                  onClick={() => {
                    setTagView("黑色系");
                  }}
                >
                  黑色系
                </button>
                <button
                  className={`titleTags ${
                    tagView === "米克斯" ? "selected" : ""
                  }`}
                  onClick={() => {
                    setTagView("米克斯");
                  }}
                >
                  米克斯
                </button>
              </div>
            </div>

            {showUpload && <UploadCard setShowUpload={setShowUpload} />}
            <div className="cardsWrapper">{cards}</div>
            <button className="toTop" onClick={toTop}>
              <i className="fas fa-chevron-up"></i>
            </button>
          </>
        );
      }

      ReactDOM.render(<CardGroup />, document.getElementById("root"));
    </script>
  </body>
</html>
