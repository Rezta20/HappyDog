<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- React  -->
    <script src="https://unpkg.com/react@16.13.1/umd/react.development.js"></script>
    <!-- React DOM -->
    <script src="https://unpkg.com/react-dom@16.13.1/umd/react-dom.development.js"></script>
    <!-- JSX Babel -->
    <script src="https://unpkg.com/@babel/standalone@7.8.3/babel.js"></script>

    <!-- Google Font  -->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome  -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    />

    <!-- Sweetalert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    <!-- Favicon  -->
    <link rel="icon" type="image/png" href="../img/favicon.png" />

    <!-- Css -->
    <link rel="stylesheet" href="../../css/photowall.css" />

    <title>Happy Dog</title>
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbarWrapper">
      <!-- Logo -->
      <div class="navbar-logoLoginWrapper">
        <div class="navbar-logoWrapper">
          <a class="logo-A" href="/Html/homepage.html">
            <img class="logo" src="../img/logo.png" alt="happyDog-logo" />
          </a>
        </div>

        <!-- Navbar Log In  -->
        <div class="login-wrapper notLoginState">
          <a class="login-A" href="/Html/Login/login.html">
            <button class="navbar-text loginBtn">登入</button>
          </a>
        </div>

        <div class="login-wrapper loginState">
          <p class="navbar-text">
            <span class="userLoginName">汪</span>，登入中&emsp;
            <span
              ><a class="login-A toMemberpage" href="/Html/Login/member.html">
                <i class="far fa-user-circle"></i
              ></a>
            </span>
          </p>
          <a class="login-A toMemberpage" href="/Html/Login/member.html"
            ><div class="userPhoto"></div
          ></a>
        </div>
      </div>

      <!-- Navbar Elements -->
      <div class="navbariconWrapperFlex">
        <div class="navbar-iconWrapper">
          <div class="navbar-element">
            <a class="navbar-A" href="/Html/homepage.html">
              <div class="navbarIcon homeIcon"></div>
              <div class="navbar-text">寵物當家</div>
            </a>
          </div>
          <div class="navbar-element">
            <a class="navbar-A" href="/Html/Booking/bookingWalking.html">
              <div class="navbarIcon bookingWalkingIcon"></div>
              <div class="navbar-text">預約散步</div>
            </a>
          </div>
          <div class="navbar-element">
            <a class="navbar-A" href="/Html/photowall.html">
              <div class="navbarIcon photoIcon"></div>
              <div class="navbar-text">毛孩日誌</div>
            </a>
          </div>
          <div class="navbar-element">
            <a class="navbar-A" href="/Html/Contact/contact.html">
              <div class="navbarIcon contactIcon"></div>
              <div class="navbar-text">聯絡我們</div>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <!-- Loading -->
    <div class="loadingWrapper">
      <div class="loading">
        <img class="loadingGif" src="/img/loading.gif" alt="" />
      </div>
    </div>

    <!-- Content -->
    <div class="contentWrapper">
      <div class="rootWrapper">
        <div id="root"></div>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <div class="footer-background">Copyright © 2020 Happy Dog</div>
    </footer>

    <!-- FrieBase  -->
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-analytics.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.1.2/firebase-storage.js"></script>

    <script>
      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      var firebaseConfig = {
        apiKey: "AIzaSyBL9Tmhwb15yAohPn_DLoAFUgVJoy76bnk",
        authDomain: "happydog-82c2f.firebaseapp.com",
        databaseURL: "https://happydog-82c2f.firebaseio.com",
        projectId: "happydog-82c2f",
        storageBucket: "happydog-82c2f.appspot.com",
        messagingSenderId: "1070136598571",
        appId: "1:1070136598571:web:0de4a08e0493465e984a6e",
        measurementId: "G-N3V1TLZNZW",
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();
    </script>

    <script src="../../JavaScript/ifLogin.js"></script>
    <script src="../../JavaScript/loading.js"></script>

    <!-- React Select  -->
    <script src="https://cdn.jsdelivr.net/npm/emotion@9.2.12/dist/emotion.umd.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.5.10/prop-types.min.js"></script>
    <script src="https://unpkg.com/react-input-autosize@2.2.1/dist/react-input-autosize.min.js"></script>
    <script src="https://unpkg.com/react-select@2.1.2/dist/react-select.min.js"></script>

    <script>
      // Firebase 監聽
      window.addEventListener("load", function () {
        firebase.auth().onAuthStateChanged((user) => {
          if (user) {
            loginState.style.display = "flex";
            notLoginState.style.display = "none";
          } else {
            loginState.style.display = "none";
            notLoginState.style.display = "flex";
          }
        });
      });
    </script>

    <script type="text/babel">
      function EditDeleteCover(props) {
        const photoWallCollection = firebase
          .firestore()
          .collection("photoWall");
        const [showDialogue, setShowDialogue] = React.useState(false);

        function clickShowDialogue() {
          // setShowDialogue(true);
          Swal.fire({
            title: "刪除這張照片嗎？",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "確定刪除",
            cancelButtonText: "取消",
          }).then((result) => {
            if (result.isConfirmed) {
              Swal.fire("已刪除", "", "success");

              // Firestore Remove Data
              photoWallCollection
                .doc(props.photoId)
                .delete()
                .then(function () {});
            }
          });
        }

        function editCardData() {
          props.editUploadPhoto(props.photoId);
        }

        return (
          <>
            <div className="editDeleteCoverWrapper">
              <div className="editText edit" onClick={editCardData}>
                編輯
              </div>
              <div className="editText delete" onClick={clickShowDialogue}>
                刪除
              </div>
            </div>
            <div
              className="deleteDialogueWrapper"
              style={{ display: showDialogue ? "block" : "none" }}
            >
              <div className="deleteDialoguecover"></div>
              <div className="deleteDialogueBox">
                <i className="fas fa-times"></i>

                <button className="deleteSure">確定刪除</button>
                <button className="canceled">取消</button>
              </div>
            </div>
          </>
        );
      }

      function Card(props) {
        function showWhoCanEdit() {
          const user = firebase.auth().currentUser;

          if (user) {
            const currentUserUid = user.providerData[0].uid;
            if (props.uid === currentUserUid) {
              return true;
            }
          }
        }

        return (
          <>
            <div className="cardWrapper">
              <div className="cardUserTitle">
                <img className="userImg" src={props.userImg} />
                <div className="userName">{props.userName}</div>
              </div>
              <img className="photoImg" src={props.photoImgUrl} />

              <div className="tags">
                {props.hashTags?.map((data) => (
                  <span> #{data.value} </span>
                ))}
              </div>
              <div className="cardDate">{props.cardDate}</div>
              <div
                className="editCoverWrapper"
                style={{ display: showWhoCanEdit() ? "block" : "none" }}
              >
                <EditDeleteCover
                  setShowUpload={props.setShowUpload}
                  photoId={props.photoId}
                  editUploadPhoto={props.editUploadPhoto}
                />
              </div>
            </div>
          </>
        );
      }

      function Tags(props) {
        const [options, setOptions] = React.useState([]);

        React.useEffect(() => {
          // Firebase firestore initializ
          const db = firebase.firestore();
          const firestoreCollection = db.collection("photoTags");

          firestoreCollection.get().then(function (docs) {
            const options = [];
            docs.forEach((doc) => {
              options.push({ value: doc.data().tag, label: doc.data().tag });
            });
            // TODO: 按照字數排序
            options.sort(function (a, b) {
              return a.value.length - b.value.length;
            });

            setOptions(options);
          });
        }, []);
        //

        function handleChange(newValue) {
          props.setSaveTag(newValue);

          if (newValue.length - 1 === -1) {
          } else {
            firebase
              .firestore()
              .collection("photoTags")
              .where("tag", "==", `${newValue[newValue.length - 1].label}`)
              .get()
              .then(function (querySnapshot) {
                if (querySnapshot.empty) {
                  firebase
                    .firestore()
                    .collection("photoTags")
                    .add({
                      tag: newValue[newValue.length - 1].label,
                    })
                    .then(function (docRef) {});
                }
              });
          }
        }

        function hashTagsSource() {
          if (props.cardDataForEdit === undefined) {
            return null;
          } else {
            return props.cardDataForEdit.hashTags;
          }
        }

        return (
          <Select.Creatable
            defaultValue={hashTagsSource()}
            options={options}
            isMulti
            name="tags"
            className="select-container"
            classNamePrefix="select"
            onChange={(e) => {
              handleChange(e);
            }}
            menuPlacement="top"
            placeholder="請選喜歡的標籤"
          />
        );
      }

      function UploadCard(props) {
        const [previewFile, setPreviewFile] = React.useState("");
        const [saveTag, setSaveTag] = React.useState([]);
        const [alreadyUpload, setAlreadyUpload] = React.useState(false);

        function previewPicture() {
          const picture = URL.createObjectURL(event.target.files[0]);
          setPreviewFile(picture);
        }

        function dataSource() {
          if (previewFile) {
            return previewFile;
          } else if (props.cardDataForEdit) {
            return props.cardDataForEdit.photo;
          }
        }

        function sendData() {
          // Get a reference to the storage service, which is used to create references in your storage bucket
          const ref = firebase.storage().ref();
          const photoWallCollection = firebase
            .firestore()
            .collection("photoWall");
          const picture = document.querySelector("#upload").files[0];
          let deleteIsNewTag;

          //  unique id
          let randomNumber = Math.floor(Math.random() * 1000);
          let time = Date.now();
          let pictureName = `photoWallPicture ${randomNumber}${time}`;
          const nativeImg =
            "https://firebasestorage.googleapis.com/v0/b/happydog-82c2f.appspot.com/o/logo%2FlogoNative1.png?alt=media&token=682b9c60-f667-471c-9169-fd69f36a9f21";

          // Cut is New element
          saveTag.forEach((item) => {
            deleteIsNewTag = delete item.__isNew__;
          });

          if (!dataSource()) {
            Swal.fire({
              title: "請上傳圖片唷",
              icon: "warning",
              confirmButtonText: "確定",
            });
          } else {
            if (!alreadyUpload) {
              setAlreadyUpload(true);
              if (dataSource() === previewFile) {
                if (props.cardDataForEdit) {
                  ref
                    .child(pictureName)
                    .put(picture)
                    .then(function (snapshot) {
                      ref
                        .child(pictureName)
                        .getDownloadURL()
                        .then(function (url) {
                          photoWallCollection
                            .doc(props.cardDataForEdit.photoId)
                            .set(
                              {
                                photo: url,
                                hashTags: saveTag,
                              },
                              { merge: true }
                            )
                            .then(function (docRef) {
                              props.setShowUpload(false);
                              setAlreadyUpload(false);
                            });
                        });
                    });
                } else {
                  ref
                    .child(pictureName)
                    .put(picture)
                    .then(function (snapshot) {
                      ref
                        .child(pictureName)
                        .getDownloadURL()
                        .then(function (url) {
                          // `url` is the download URL for 'images/stars.jpg'
                          const user = firebase.auth().currentUser;
                          const userData = user.providerData[0];

                          if (
                            userData.displayName === null ||
                            userData.photoURL === null
                          ) {
                            photoWallCollection
                              .add({
                                photo: url,
                                hashTags: saveTag,
                                rank: firebase.firestore.FieldValue.serverTimestamp(),
                                time: `${new Date().getFullYear()}.${
                                  new Date().getMonth() + 1
                                }.${new Date().getDate()}`,
                                user: "Happy Dog",
                                userPhoto: nativeImg,
                                uid: userData.uid,
                              })
                              .then(function (docRef) {
                                // Add id
                                photoWallCollection
                                  .doc(docRef.id)
                                  .set(
                                    { photoId: `${docRef.id}` },
                                    { merge: true }
                                  );
                                props.setShowUpload(false);
                                setAlreadyUpload(false);
                              })
                              .catch(function (error) {
                                console.error(
                                  "Error writing document: ",
                                  error
                                );
                              });
                          } else {
                            photoWallCollection
                              .add({
                                photo: url,
                                hashTags: saveTag,
                                rank: firebase.firestore.FieldValue.serverTimestamp(),
                                time: `${new Date().getFullYear()}.${
                                  new Date().getMonth() + 1
                                }.${new Date().getDate()}`,
                                user: userData.displayName,
                                userPhoto: userData.photoURL,
                                uid: userData.uid,
                              })
                              .then(function (docRef) {
                                // clicked = false;

                                photoWallCollection
                                  .doc(docRef.id)
                                  .set(
                                    { photoId: `${docRef.id}` },
                                    { merge: true }
                                  );
                                props.setShowUpload(false);
                                setAlreadyUpload(false);
                              });
                          }
                        });
                    });
                }
              } else if (dataSource() === props.cardDataForEdit.photo) {
                photoWallCollection
                  .doc(props.cardDataForEdit.photoId)
                  .set(
                    {
                      photo: props.cardDataForEdit.photo,
                      hashTags: saveTag,
                    },
                    { merge: true }
                  )
                  .then(function (docRef) {
                    props.setShowUpload(false);
                    setAlreadyUpload(false);
                  });
              }
            }
          }
        }

        return (
          <div className="uploadCardWrapperFlex">
            <div
              className="cover"
              onClick={() => {
                props.setShowUpload(false);
              }}
            ></div>
            <div className="uploadCardWrapper fade-in-fwd">
              <div className="crossWrapper">
                <i
                  className="fas fa-times"
                  onClick={() => {
                    props.setShowUpload(false);
                  }}
                ></i>
              </div>
              <div className="uploadContentWrapper">
                <div className="uploadArea">
                  <p
                    className="previewText"
                    style={{ display: dataSource() ? "none" : "block" }}
                  >
                    預覽圖片
                  </p>
                  <img
                    className="previewPicture"
                    src={dataSource()}
                    alt=""
                    style={{
                      width: dataSource() ? 320 : "auto",
                      height: dataSource() ? 401 : "auto",
                      objectFit: dataSource() ? "contain" : "",
                    }}
                  />
                </div>
                <div className="uploadIconWrapper">
                  <label htmlFor="upload" className="uploadIcon">
                    <div className="uploadText">上傳圖片</div>
                    <i className="fas fa-file-upload fa-2x"></i>
                  </label>
                  <input
                    type="file"
                    id="upload"
                    name="image"
                    accept="image/jpg, image/png, image/svg"
                    onChange={previewPicture}
                  />
                </div>
                <Tags
                  setSaveTag={setSaveTag}
                  cardDataForEdit={props.cardDataForEdit}
                />
              </div>

              <div className="sendPhotoBtnWrapper">
                <button className="sendPhotoBtn" onClick={sendData}>
                  {alreadyUpload ? "確認送出" : "送出中"}
                </button>
              </div>
            </div>
          </div>
        );
      }

      function CardGroup(props) {
        const [show, setShow] = React.useState(false);
        const [index, setIndex] = React.useState(0);
        const [data, setData] = React.useState([]);
        const [showUpload, setShowUpload] = React.useState(false);
        const [uploadPhotoId, setUploadPhotoId] = React.useState();
        const [tagView, setTagView] = React.useState("全部");

        function editUploadPhoto(photoId) {
          setShowUpload(true);
          setUploadPhotoId(photoId);
        }

        const cardDataForEdit = data.find(
          (card) => card.photoId === uploadPhotoId
        );

        // 從Firebase上 抓資料
        React.useEffect(() => {
          // Firebase firestore initializ
          const photoWallCollection = firebase
            .firestore()
            .collection("photoWall");

          photoWallCollection
            .orderBy("rank", "desc")
            .onSnapshot(function (doc) {
              const dataArray = [];
              doc.forEach(function (doc) {
                dataArray.push(doc.data());
              });
              setData(dataArray);
            });
        }, []);

        const cards = [];

        for (let i = 0; i < data.length; i++) {
          let shouldPushCard = false;
          /* TODO: 如果 data 裡的 hashTags 有包含 tagView 就 push 進去 */
          if (tagView === "全部") {
            shouldPushCard = true;
          } else {
            data[i].hashTags.forEach((item) => {
              if (item.label === tagView) {
                shouldPushCard = true;
              }
            });
          }
          if (shouldPushCard) {
            // true
            cards.push(
              <Card
                key={data[i].rank}
                index={i}
                userImg={data[i].userPhoto}
                userName={data[i].user}
                photoImgUrl={data[i].photo}
                hashTags={data[i].hashTags}
                cardDate={data[i].time}
                photoId={data[i].photoId}
                uid={data[i].uid}
                setShow={setShow}
                setIndex={setIndex}
                setShowUpload={setShowUpload}
                editUploadPhoto={editUploadPhoto}
              />
            );
          }
        }

        function toTop() {
          window.scrollTo({ top: 0, behavior: "smooth" });
        }

        return (
          <>
            <div className="uploadBtnWrapper">
              <div className="uploadPictureDescriptionWrapper">
                <div className="uploadPictureDescription">
                  和我們分享你家寶貝最可愛的一面吧！
                </div>
                <div className="uploadPictureDescriptionTriangle"></div>
              </div>

              <button
                className="uploadBtn"
                onClick={() => {
                  if (firebase.auth().currentUser === null) {
                    Swal.fire({
                      title: "請先登入帳號",
                      icon: "warning",
                      confirmButtonText: "確定",
                    }).then(function () {
                      location.href = "../Html/Login/login.html";
                    });
                  } else {
                    setShowUpload(true);
                  }
                }}
              >
                上傳圖片
              </button>
            </div>

            <div className="titleTagsOutsideWrapper">
              <div className="titleTagsWrapper">
                <button
                  className={`titleTags ${
                    tagView === "全部" ? "selected" : ""
                  }`}
                  onClick={() => {
                    setTagView("全部");
                  }}
                >
                  全部
                </button>
                <button
                  className={`titleTags ${
                    tagView === "可愛" ? "selected" : ""
                  }`}
                  onClick={() => {
                    setTagView("可愛");
                  }}
                >
                  可愛
                </button>
                <button
                  className={`titleTags ${
                    tagView === "有趣" ? "selected" : ""
                  }`}
                  onClick={() => {
                    setTagView("有趣");
                  }}
                >
                  有趣
                </button>
                <button
                  className={`titleTags ${
                    tagView === "黃色系" ? "selected" : ""
                  }`}
                  onClick={() => {
                    setTagView("黃色系");
                  }}
                >
                  黃色系
                </button>
                <button
                  className={`titleTags ${
                    tagView === "黑色系" ? "selected" : ""
                  }`}
                  onClick={() => {
                    setTagView("黑色系");
                  }}
                >
                  黑色系
                </button>
                <button
                  className={`titleTags ${
                    tagView === "米克斯" ? "selected" : ""
                  }`}
                  onClick={() => {
                    setTagView("米克斯");
                  }}
                >
                  米克斯
                </button>
              </div>
            </div>

            {showUpload && (
              <UploadCard
                setShowUpload={setShowUpload}
                cardDataForEdit={cardDataForEdit}
              />
            )}
            <div className="cardsWrapper">{cards}</div>
            <button className="toTop" onClick={toTop}>
              <i className="fas fa-chevron-up"></i>
            </button>
          </>
        );
      }

      ReactDOM.render(<CardGroup />, document.getElementById("root"));
    </script>
  </body>
</html>
